# TCP/IP

## 网际层(IP层)

这一层主要由**IP**和**ICMP**两个协议组成。网络层的主要作用：“实现终端节点之间的通信”（“点对点通信”）。IP属于面向无连接型，在发包前，不需要建立对目的地址之间的连接。

### 一. IP

- [IP寻址](#IP寻址)
- [路由](#路由)
- [IP分包与组包](#IP分包与组包)
- [IPv6](#IPv6)
- [IPv4首部](#IPv4首部)

---

#### IP寻址

IP地址（IPv4地址）由32位正整数表示，习惯上以8位一组，分为4组，以“."隔开，再将每组化为十进制。IP地址分为**网络号**和**主机号**。IP地址分为***A、B、C、D类***。

广播地址用于在同一个链路中相互连接的主机之间发送数据包，广播分为**本地广播**和**直接广播**。

直接使用A、B、C类地址会造成浪费，实际上采用**子网掩码**来实现更灵活的网络分配。

#### 路由

在发送数据包时仅有IP地址时不够的，还需要有**路由控制表（Routing Table）**，其中保存着指明路由器或主机的信息。路由控制表的形成方式：管理员手动设置（静态路由控制）和路由器之间交换信息时自动刷新（动态路由控制）。IP本身没有制定路由表的协议，该表是由*“路由协议”*制定的。

**路由聚合**能有效减小路由表的条目，而且路由聚合可以将已知的路由信息传送给周围其他的路由器，以达到控制路由信息的目的。

#### IP分包与组包

不同的数据链路最大的区别是它们各自的最大传输单位(MTU)不同，因此需要分片处理。

最初的分片机制会加重路由器负担，因此，产生了一种新的技术***“路径MTU发现”***。采用路径MTU发现机制后，路由器不再对数据包进行分片。路径MTU指的是从发送端主机到接收端主机之间不需要分片的最大MTU大小，即**路径中存在的所有数据链路中最小的MTU**。

路径MTU发现的机制在UDP和TCP情况下有所不同：

- UDP数据报被丢弃后不会重发，因此修改MTU后从UDP层传来的数据报会在IP层被分片
- TCP数据报被丢弃后会重发，修改MTU后新的数据报将被TCP分片，而不再由IP层分片

#### IPv6

IPv6是为了根本解决IPv4地址耗尽的问题提出的，**IPv6地址长128比特**，一般将128比特的地址以每16比特为一组，每组用“:”隔开，如果出现连续的0可以将这些0省略，并用“::”隔开。

IPv6地址常分为：全局单播地址、链路本地单播地址、唯一本地地址。

IPv6的**分片操作只在作为起点的发送端主机上进行**，路由器不参与分片（路径MTU发现技术）。IPv6中最小的MTU为1280字节。

#### IPv4首部

- 版本：4比特，IPv4版本号为4，IPv6版本号为6。
- 首部长度：4比特，单位为4字节，对于没有可选项的IP包，首部长度设置为5，也就是20字节。
- 总长度：表示IP首部和数据部分合起来的总字节数。该字段长16比特，因此IP包的最大长度为65535（= 2^16^）字节。
- 标识：16比特，用于分片重组。同一个分片的标识值相同。
- 标志：3比特构成（0xx），第二位表示是否进行分片，0表示可以分片，1表示不能分片；第三位表示包被分片的情况下，表示是否为最后一个包，0表示最后一个分片的包，1表示分片中段的包。
- 片偏移：13比特，用来标识被分片的每一个分段相对于原始数据的位置，单位为8字节。第一个分片对应的值为0。
- 生存时间(TTL)：8比特构成，实际中指的是可以中转多少个路由器，当TTL减到0时丢弃包。
- 协议：8比特，表示的是IP包传输层的上层协议编号。
- 首部校验和：16比特构成，也叫IP首部校验和。该字段只校验数据报的首部，不校验数据部分。主要用来确保IP数据报不被破坏。

### 二、IP协议相关技术

- DNS
- ARP

---

#### DNS

DNS不仅适用于IPv4，也使用于IPv6。

通过**域名服务器**查询域名的IP地址，解析器和域名服务器了解到的最新的消息暂时保存在缓存中。

#### ARP

以IP地址为线索，用ARP来定位下一个应该接收数据报的网络设备对应的MAC地址。ARP只适用于IPv4，不适用于IPv6。ARP的通信机制：

已知主机A和主机B的IP地址，它们互不知道对方的MAC地址。主机A为了获得B的MAC地址，首先通过**广播**发送一个ARP请求包，包中包含了主机B的IP地址。ARP请求包会被同一链路上的所有主机和路由器接收，如果ARP请求包中的IP地址和自己的IP地址一样，那么这个节点就将自己的MAC地址塞入ARP响应包返回给主机A。主机A会将获得的MAC地址作为IP对MAC的映射关系记忆到**ARP缓存表**中。

ARP的**作用范围**：逐段链路或逐个网络
